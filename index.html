<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìì¬ ê²¬ì  í†µí•© ì‹œìŠ¤í…œ v3</title>
    <style>
        :root {
            --ios-blue: #007AFF; --ios-green: #34C759; --ios-orange: #FF9500;
            --ios-purple: #5856D6; --ios-bg: #F2F2F7; --ios-card: #FFFFFF;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--ios-bg); margin: 0; padding: 15px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 140px; }
        
        /* íƒ­ ë””ìì¸ */
        .mode-selector { display: flex; background: #E5E5EA; border-radius: 10px; padding: 2px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .mode-btn.active { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .card { background: var(--ios-card); border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { font-size: 19px; font-weight: 700; text-align: center; margin-bottom: 20px; color: #1c1c1e; }
        
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 12px; font-weight: 500; color: #8E8E93; margin: 0 0 5px 5px; }
        input, select, textarea { width: 100%; padding: 12px; border: none; background: #F2F2F7; border-radius: 12px; font-size: 16px; outline: none; box-sizing: border-box; }
        
        .btn { width: 100%; border: none; border-radius: 12px; font-weight: 600; padding: 14px; cursor: pointer; margin-top: 10px; color: white; transition: 0.2s; }
        .btn-request { background: var(--ios-blue); }
        .btn-calculate { background: var(--ios-green); }
        .btn-pdf { background: var(--ios-purple); margin-top: 15px; }

        .item { background: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; border-left: 6px solid #CCC; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .unit-edit { width: 90px !important; padding: 8px !important; font-size: 14px !important; text-align: right; background: #FFF !important; border: 1px solid var(--ios-blue) !important; color: #000; font-weight: bold; }
        
        .admin-only { display: none; }
        .total-card { background: #1C1C1E; color: white; border-radius: 15px; padding: 18px; margin-top: 15px; display: none; }

        @media print {
            .mode-selector, .card, .btn, .del-btn, .admin-parse-area, .unit-label-print { display: none !important; }
            body { background: white; padding: 0; }
            .item { border: 1px solid #EEE; border-left: 6px solid #CCC; break-inside: avoid; }
            .unit-val-display { display: inline !important; font-weight: bold; }
            .unit-edit { display: none !important; }
            .total-card { display: block !important; background: #F2F2F7 !important; color: #000 !important; border: 1px solid #000; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="mode-selector">
        <button id="user-mode-btn" class="mode-btn active" onclick="switchMode('user')">ê³ ê° (ê²¬ì ìš”ì²­)</button>
        <button id="admin-mode-btn" class="mode-btn" onclick="switchMode('admin')">ì—…ì²´ (ë‹¨ê°€ì‚°ì¶œ)</button>
    </div>

    <div class="card admin-only admin-parse-area" style="border: 2px solid var(--ios-blue);">
        <label style="color:var(--ios-blue); font-weight:bold;">ğŸ“© ê³ ê° ë¬¸ì ë¶™ì—¬ë„£ê¸°</label>
        <textarea id="rawText" placeholder="ê³ ê°ì´ ë³´ë‚¸ 100*200*10 í˜•ì‹ ë¬¸ìë¥¼ ë„£ìœ¼ì„¸ìš”"></textarea>
        <button class="btn" style="background:#1C1C1E; font-size:13px; padding:10px;" onclick="parseText()">ìë™ ë¶„ì„ í›„ ëª©ë¡ ì¶”ê°€</button>
    </div>

    <div class="card">
        <h2 id="title">ìì¬ ê²¬ì  ìš”ì²­</h2>
        <div class="input-group">
            <label>ìì¬/í˜•íƒœ</label>
            <div style="display:flex; gap:5px;">
                <select id="material" style="flex:1;">
                    <option value="7.93">SUS304</option>
                    <option value="7.85">SS400</option>
                    <option value="2.7">ì•Œë£¨ë¯¸ëŠ„</option>
                </select>
                <select id="shape" style="flex:1;" onchange="toggleInputs()">
                    <option value="square">ì‚¬ê°íŒ</option>
                    <option value="circle">í™˜ë´‰</option>
                </select>
            </div>
        </div>

        <div id="square-inputs" class="input-group">
            <label>ê°€ë¡œ x ì„¸ë¡œ (mm)</label>
            <div style="display:flex; gap:8px;"><input type="number" id="w" placeholder="ê°€ë¡œ"><input type="number" id="l" placeholder="ì„¸ë¡œ"></div>
        </div>
        <div id="circle-inputs" class="input-group" style="display:none;">
            <label>ì§€ë¦„ (D mm)</label>
            <input type="number" id="dia" placeholder="ì§€ë¦„">
        </div>

        <div class="input-group">
            <label>ë‘ê»˜(T) / ê¸¸ì´(L) mm</label>
            <input type="number" id="t" placeholder="ì…ë ¥">
        </div>

        <div class="input-group admin-only" id="admin-unit-input">
            <label>ê¸°ë³¸ ì ìš© ë‹¨ê°€ (ì›/kg)</label>
            <input type="number" id="unitPrice" value="5000">
        </div>

        <button id="main-btn" class="btn btn-request" onclick="addItem()">ëª©ë¡ì— ì¶”ê°€</button>
    </div>

    <div id="items"></div>

    <div class="total-card admin-only" id="total-area">
        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:12px; color:#AAA;">
            <span id="print-date"></span>
            <span>ì´ ì¤‘ëŸ‰: <b id="total-w" style="color:#fff;">0.000</b> kg</span>
        </div>
        <div style="display:flex; justify-content:space-between; border-top:1px solid #3A3A3C; padding-top:15px;">
            <span style="font-weight:bold; font-size:16px;">ìµœì¢… í•©ê³„</span><strong id="total-p" style="color:#FFD60A; font-size:22px;">0</strong>ì›
        </div>
    </div>

    <button class="btn btn-pdf admin-only" onclick="generatePdf()">ğŸ“„ ì •ì‹ ê²¬ì ì„œ PDF ë°œí–‰</button>
    <button id="send-btn" class="btn btn-request" onclick="sendToOwner()">ğŸ“© ì—…ì²´ì— ê²¬ì  ìš”ì²­ (ë¬¸ìì „ì†¡)</button>
</div>

<script>
    let itemList = [];
    let currentMode = 'user';

    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(mode + '-mode-btn').classList.add('active');
        
        // ì—…ì²´ìš© ìš”ì†Œë“¤ ì œì–´
        document.querySelectorAll('.admin-only').forEach(e => e.style.display = (mode === 'admin' ? 'block' : 'none'));
        
        document.getElementById('title').innerText = (mode === 'admin' ? "ê°œë³„ ë‹¨ê°€ ì‚°ì¶œ (ì—…ì²´ìš©)" : "ìì¬ ê²¬ì  ìš”ì²­");
        document.getElementById('main-btn').className = "btn " + (mode === 'admin' ? "btn-calculate" : "btn-request");
        document.getElementById('main-btn').innerText = (mode === 'admin' ? "ëª©ë¡ì— ìˆ˜ë™ ì¶”ê°€" : "ëª©ë¡ì— ì¶”ê°€");
        document.getElementById('send-btn').style.display = (mode === 'admin' ? 'none' : 'block');
        
        renderList();
    }

    function toggleInputs() {
        const s = document.getElementById('shape').value;
        document.getElementById('square-inputs').style.display = (s === 'square') ? 'block' : 'none';
        document.getElementById('circle-inputs').style.display = (s === 'circle') ? 'block' : 'none';
    }

    function addItem() {
        const mat = document.getElementById('material');
        const opt = mat.options[mat.selectedIndex];
        const g = parseFloat(opt.value);
        const shape = document.getElementById('shape').value;
        const t = document.getElementById('t').value / 10;
        
        // ì—…ì²´ìš© ëª¨ë“œë©´ í˜„ì¬ ì…ë ¥ëœ ë‹¨ê°€ ì‚¬ìš©, ê³ ê°ìš©ì´ë©´ ë‹¨ê°€ 0ìœ¼ë¡œ ì„¸íŒ…
        const up = currentMode === 'admin' ? parseInt(document.getElementById('unitPrice').value) : 0;
        
        let wgt = 0; let txt = "";
        if (shape === 'square') {
            const w = document.getElementById('w').value / 10;
            const l = document.getElementById('l').value / 10;
            if(!w || !l || !t) return alert("ì¹˜ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            wgt = (w * l * t * g) / 1000;
            txt = `${opt.text}(ì‚¬ê°) ${w*10}*${l*10}*${t*10}`;
        } else {
            const d = document.getElementById('dia').value / 10;
            if(!d || !t) return alert("ì§€ë¦„ê³¼ ê¸¸ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            wgt = (Math.pow(d/2, 2) * Math.PI * t * g) / 1000;
            txt = `${opt.text}(í™˜ë´‰) D${d*10}*L${t*10}`;
        }
        itemList.push({ id: Date.now(), txt, weight: wgt, unit: up });
        renderList();
    }

    // ë‹¨ê°€ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ í•©ê³„ ë°˜ì˜ ë¡œì§ ì¶”ê°€
    function updateItemUnit(id, newUnit) {
        const idx = itemList.findIndex(item => item.id == id);
        if(idx > -1) {
            itemList[idx].unit = parseInt(newUnit) || 0;
            const costDisplay = document.getElementById('cost-' + id);
            if(costDisplay) {
                const newCost = Math.round(itemList[idx].weight * itemList[idx].unit);
                costDisplay.innerText = newCost.toLocaleString() + "ì›";
            }
            renderTotal(); // í•˜ë‹¨ ì´í•©ê³„ ì¦‰ì‹œ ê°±ì‹ 
        }
    }

    function renderList() {
        const container = document.getElementById('items');
        container.innerHTML = "";
        itemList.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'item';
            const cost = Math.round(item.weight * item.unit);
            
            let html = `<b>${i+1}. ${item.txt}</b>`;
            if (currentMode === 'admin') {
                html += `
                <div class="item-row">
                    <span style="font-size:13px; color:#666;">${item.weight.toFixed(3)}kg</span>
                    <span>
                        <span class="unit-label-print" style="font-size:11px; color:#999;">ë‹¨ê°€:</span>
                        <input type="number" class="unit-edit" value="${item.unit}" oninput="updateItemUnit(${item.id}, this.value)">
                        <b class="unit-val-display" style="display:none;">@${item.unit.toLocaleString()}</b>
                        <b id="cost-${item.id}" style="margin-left:8px; color:var(--ios-blue); font-size:16px;">${cost.toLocaleString()}ì›</b>
                    </span>
                </div>`;
            } else {
                html += `<p style="font-size:13px; color:#8E8E93; margin-top:5px;">ìƒì„¸ ê²¬ì  í™•ì¸ ì¤‘...</p>`;
            }
            html += `<button onclick="deleteItem(${item.id})" class="del-btn" style="position:absolute; right:12px; top:12px; border:none; background:none; color:#FF3B30; font-size:12px; cursor:pointer;">ì‚­ì œ</button>`;
            div.innerHTML = html;
            container.appendChild(div);
        });
        renderTotal();
    }

    function renderTotal() {
        let tw = 0; let tp = 0;
        itemList.forEach(item => {
            tw += item.weight;
            tp += Math.round(item.weight * item.unit);
        });
        document.getElementById('total-w').innerText = tw.toFixed(3);
        document.getElementById('total-p').innerText = tp.toLocaleString();
    }

    function deleteItem(id) { itemList = itemList.filter(i => i.id !== id); renderList(); }

    function parseText() {
        const raw = document.getElementById('rawText').value;
        const defaultUp = parseInt(document.getElementById('unitPrice').value);
        const lines = raw.split('\n');
        lines.forEach(line => {
            const match = line.match(/(\d+(?:\.\d+)?)\*(\d+(?:\.\d+)?)\*(\d+(?:\.\d+)?)/);
            if (match) {
                const w = parseFloat(match[1])/10; const l = parseFloat(match[2])/10; const t = parseFloat(match[3])/10;
                let g = 7.93; let name = "SUS304";
                if(line.includes("SS400")) { g = 7.85; name = "SS400"; }
                else if(line.includes("ì•Œë£¨ë¯¸ëŠ„") || line.includes("AL")) { g = 2.7; name = "ì•Œë£¨ë¯¸ëŠ„"; }
                const wgt = (w * l * t * g) / 1000;
                itemList.push({ id: Date.now()+Math.random(), txt: `${name}(ì‚¬ê°) ${w*10}*${l*10}*${t*10}`, weight: wgt, unit: defaultUp });
            }
        });
        renderList();
        document.getElementById('rawText').value = "";
    }

    function generatePdf() {
        document.getElementById('print-date').innerText = "ì¼ì‹œ: " + new Date().toLocaleString();
        window.print();
    }

    function sendToOwner() {
        if(itemList.length === 0) return alert("ëª©ë¡ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.");
        let s = "[ìì¬ ê²¬ì  ìš”ì²­]\n";
        itemList.forEach((item, i) => { s += `${i+1}. ${item.txt}\n`; });
        s += "\nê²¬ì  ë¶€íƒë“œë¦½ë‹ˆë‹¤.";
        location.href = `sms:01000000000?body=${encodeURIComponent(s)}`;
    }
</script>
</body>
</html>
