<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìì¬ ê²¬ì  í†µí•© ì‹œìŠ¤í…œ v4</title>
    <style>
        :root {
            --ios-blue: #007AFF; --ios-green: #34C759; --ios-orange: #FF9500;
            --ios-purple: #5856D6; --ios-bg: #F2F2F7; --ios-card: #FFFFFF;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--ios-bg); margin: 0; padding: 15px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 120px; }
        
        /* íƒ­ ë””ìì¸ */
        .mode-selector { display: flex; background: #E5E5EA; border-radius: 10px; padding: 2px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; color: #8E8E93; }
        .mode-btn.active { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #000; }

        .card { background: var(--ios-card); border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { font-size: 19px; font-weight: 700; text-align: center; margin-bottom: 20px; color: #1c1c1e; }
        
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 12px; font-weight: 500; color: #8E8E93; margin: 0 0 5px 5px; }
        input, select, textarea { width: 100%; padding: 12px; border: none; background: #F2F2F7; border-radius: 12px; font-size: 16px; outline: none; box-sizing: border-box; }
        textarea { height: 100px; resize: none; border: 2px dashed var(--ios-green); background: #fff; }
        
        .btn { width: 100%; border: none; border-radius: 12px; font-weight: 600; padding: 14px; cursor: pointer; margin-top: 10px; color: white; transition: 0.2s; }
        .btn-request { background: var(--ios-blue); }
        .btn-calculate { background: var(--ios-green); }
        .btn-pdf { background: var(--ios-purple); margin-top: 15px; }
        .btn-parse { background: #1C1C1E; font-size: 14px; padding: 12px; margin-top: 8px; }

        .item { background: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; border-left: 6px solid #CCC; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .unit-edit { width: 90px !important; padding: 8px !important; font-size: 14px !important; text-align: right; background: #FFF !important; border: 1px solid var(--ios-blue) !important; color: #000; font-weight: bold; }
        
        .admin-only { display: none; }
        .user-only { display: block; }
        .total-card { background: #1C1C1E; color: white; border-radius: 15px; padding: 18px; margin-top: 15px; display: none; }

        @media print {
            .mode-selector, .card, .btn, .del-btn, .admin-parse-area, .unit-label-print { display: none !important; }
            body { background: white; padding: 0; }
            .item { border: 1px solid #EEE; border-left: 6px solid #CCC; break-inside: avoid; }
            .unit-val-display { display: inline !important; font-weight: bold; }
            .unit-edit { display: none !important; }
            .total-card { display: block !important; background: #F2F2F7 !important; color: #000 !important; border: 1px solid #000; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="mode-selector">
        <button id="user-mode-btn" class="mode-btn active" onclick="switchMode('user')">â‘  ê³ ê° (ê²¬ì ìš”ì²­)</button>
        <button id="admin-mode-btn" class="mode-btn" onclick="switchMode('admin')">â‘¡ ì—…ì²´ (ë‹¨ê°€ì‚°ì¶œ)</button>
    </div>

    <div class="card admin-only admin-parse-area" style="border: 2px solid var(--ios-green);">
        <label style="color:var(--ios-green); font-weight:bold; font-size:14px;">ğŸ“© ê³ ê° ë¬¸ì ë¶™ì—¬ë„£ê¸° (ì „ì²´)</label>
        <textarea id="rawText" placeholder="ê³ ê°ì´ ë³´ë‚¸ ë¬¸ìë¥¼ í†µì§¸ë¡œ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ì—¬ëŸ¬ ì¤„ ê°€ëŠ¥)"></textarea>
        <button class="btn btn-parse" onclick="parseText()">ğŸ” ìë™ ë¶„ì„í•˜ì—¬ ëª©ë¡ì— ì¶”ê°€</button>
    </div>

    <div class="card">
        <h2 id="title">ìì¬ ê²¬ì  ìš”ì²­</h2>
        <div class="input-group">
            <label>ìì¬ / í˜•íƒœ</label>
            <div style="display:flex; gap:5px;">
                <select id="material" style="flex:1;">
                    <option value="7.93">SUS304</option>
                    <option value="7.85">SS400</option>
                    <option value="2.7">ì•Œë£¨ë¯¸ëŠ„</option>
                </select>
                <select id="shape" style="flex:1;" onchange="toggleInputs()">
                    <option value="square">ì‚¬ê°íŒ</option>
                    <option value="circle">í™˜ë´‰</option>
                </select>
            </div>
        </div>

        <div id="square-inputs" class="input-group">
            <label>ê°€ë¡œ x ì„¸ë¡œ (mm)</label>
            <div style="display:flex; gap:5px;"><input type="number" id="w" placeholder="ê°€ë¡œ"><input type="number" id="l" placeholder="ì„¸ë¡œ"></div>
        </div>
        <div id="circle-inputs" class="input-group" style="display:none;">
            <label>ì§€ë¦„ (D mm)</label>
            <input type="number" id="dia" placeholder="ì§€ë¦„">
        </div>

        <div class="input-group">
            <label>ë‘ê»˜(T) / ê¸¸ì´(L) mm</label>
            <input type="number" id="t" placeholder="ì…ë ¥">
        </div>

        <div class="input-group admin-only" id="admin-unit-input">
            <label>ê¸°ë³¸ ì ìš© ë‹¨ê°€ (ì›/kg)</label>
            <input type="number" id="unitPrice" value="5000">
        </div>

        <button id="main-btn" class="btn btn-request" onclick="addItem()">ëª©ë¡ì— ì¶”ê°€</button>
    </div>

    <div id="items"></div>

    <div class="total-card admin-only" id="total-area">
        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:12px; color:#AAA;">
            <span id="print-date"></span>
            <span>ì´ ì¤‘ëŸ‰: <b id="total-w" style="color:#fff;">0.000</b> kg</span>
        </div>
        <div style="display:flex; justify-content:space-between; border-top:1px solid #3A3A3C; padding-top:15px;">
            <span style="font-weight:bold; font-size:16px;">ìµœì¢… í•©ê³„</span><strong id="total-p" style="color:#FFD60A; font-size:22px;">0</strong>ì›
        </div>
    </div>

    <button class="btn btn-pdf admin-only" onclick="generatePdf()">ğŸ“„ ì •ì‹ ê²¬ì ì„œ PDF ë°œí–‰</button>
    <button id="send-btn" class="btn btn-request user-only" onclick="sendToOwner()">ğŸ“© ì—…ì²´ì— ê²¬ì  ìš”ì²­ (ë¬¸ìì „ì†¡)</button>
</div>

<script>
    let itemList = [];
    let currentMode = 'user';

    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(mode + '-mode-btn').classList.add('active');
        
        // ëª¨ë“œì— ë”°ë¼ í‘œì‹œ ìš”ì†Œ ì œì–´
        if (mode === 'admin') {
            document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
            document.querySelectorAll('.user-only').forEach(e => e.style.display = 'none');
            document.getElementById('title').innerText = "ê°œë³„ ë‹¨ê°€ ì‚°ì¶œ (ì—…ì²´ìš©)";
            document.getElementById('main-btn').className = "btn btn-calculate";
            document.getElementById('main-btn').innerText = "ëª©ë¡ì— ìˆ˜ë™ ì¶”ê°€";
        } else {
            // ê³ ê° ëª¨ë“œë¡œ ëŒì•„ì˜¬ ë•Œ ëª©ë¡ ì´ˆê¸°í™” ì—¬ë¶€ (ì„ íƒì‚¬í•­, í˜„ì¬ëŠ” ìœ ì§€)
            document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.user-only').forEach(e => e.style.display = 'block');
            document.getElementById('title').innerText = "ìì¬ ê²¬ì  ìš”ì²­";
            document.getElementById('main-btn').className = "btn btn-request";
            document.getElementById('main-btn').innerText = "ëª©ë¡ì— ì¶”ê°€";
        }
        renderList();
    }

    function toggleInputs() {
        const s = document.getElementById('shape').value;
        document.getElementById('square-inputs').style.display = (s === 'square') ? 'block' : 'none';
        document.getElementById('circle-inputs').style.display = (s === 'circle') ? 'block' : 'none';
    }

    function addItem() {
        const mat = document.getElementById('material');
        const opt = mat.options[mat.selectedIndex];
        const g = parseFloat(opt.value);
        const shape = document.getElementById('shape').value;
        const t = document.getElementById('t').value / 10;
        const up = currentMode === 'admin' ? parseInt(document.getElementById('unitPrice').value) : 0;
        
        let wgt = 0; let txt = "";
        if (shape === 'square') {
            const w = document.getElementById('w').value / 10;
            const l = document.getElementById('l').value / 10;
            if(!w || !l || !t) return alert("ì¹˜ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            wgt = (w * l * t * g) / 1000;
            txt = `${opt.text}(ì‚¬ê°) ${w*10}*${l*10}*${t*10}`;
        } else {
            const d = document.getElementById('dia').value / 10;
            if(!d || !t) return alert("ì§€ë¦„ê³¼ ê¸¸ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            wgt = (Math.pow(d/2, 2) * Math.PI * t * g) / 1000;
            txt = `${opt.text}(í™˜ë´‰) D${d*10}*L${t*10}`;
        }
        itemList.push({ id: Date.now(), txt, weight: wgt, unit: up });
        renderList();
    }

    function updateItemUnit(id, newUnit) {
        const idx = itemList.findIndex(item => item.id == id);
        if(idx > -1) {
            itemList[idx].unit = parseInt(newUnit) || 0;
            const costDisplay = document.getElementById('cost-' + id);
            if(costDisplay) {
                const newCost = Math.round(itemList[idx].weight * itemList[idx].unit);
                costDisplay.innerText = newCost.toLocaleString() + "ì›";
            }
            renderTotal();
        }
    }

    function renderList() {
        const container = document.getElementById('items');
        container.innerHTML = "";
        itemList.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'item';
            const cost = Math.round(item.weight * item.unit);
            
            let html = `<b>${i+1}. ${item.txt}</b>`;
            if (currentMode === 'admin') {
                html += `
                <div class="item-row">
                    <span style="font-size:13px; color:#666;">${item.weight.toFixed(3)}kg</span>
                    <span>
                        <span class="unit-label-print" style="font-size:11px; color:#999;">ë‹¨ê°€:</span>
                        <input type="number" class="unit-edit" value="${item.unit}" oninput="updateItemUnit(${item.id}, this.value)">
                        <b class="unit-val-display" style="display:none;">@${item.unit.toLocaleString()}</b>
                        <b id="cost-${item.id}" style="margin-left:8px; color:var(--ios-blue); font-size:16px;">${cost.toLocaleString()}ì›</b>
                    </span>
                </div>`;
            } else {
                html += `<p style="font-size:13px; color:#8E8E93; margin-top:5px;">ê²¬ì  ì‚°ì¶œ ëŒ€ê¸° ì¤‘</p>`;
            }
            html += `<button onclick="deleteItem(${item.id})" class="del-btn" style="position:absolute; right:12px; top:12px; border:none; background:none; color:#FF3B30; font-size:12px; cursor:pointer;">ì‚­ì œ</button>`;
            div.innerHTML = html;
            container.appendChild(div);
        });
        renderTotal();
    }

    function renderTotal() {
        let tw = 0; let tp = 0;
        itemList.forEach(item => {
            tw += item.weight;
            tp += Math.round(item.weight * item.unit);
        });
        document.getElementById('total-w').innerText = tw.toFixed(3);
        document.getElementById('total-p').innerText = tp.toLocaleString();
    }

    function deleteItem(id) { itemList = itemList.filter(i => i.id !== id); renderList(); }

    // ğŸš€ ìˆ˜ì •ëœ íŒŒì‹± ë¡œì§: ì—¬ëŸ¬ ì¤„ì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ì½ì–´ì„œ ì¶”ê°€í•¨
    function parseText() {
        const raw = document.getElementById('rawText').value;
        if(!raw) return alert("ë¶„ì„í•  ë¬¸ìê°€ ì—†ìŠµë‹ˆë‹¤.");

        const defaultUp = parseInt(document.getElementById('unitPrice').value);
        
        // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë‚˜ëˆ„ê³ , ë¹ˆ ì¤„ ì œê±°
        const lines = raw.split(/\r?\n/).filter(line => line.trim() !== "");
        let count = 0;

        lines.forEach(line => {
            // ì •ê·œì‹: ìˆ«ì*ìˆ«ì*ìˆ«ì íŒ¨í„´ì„ ì°¾ìŒ (ê³µë°± í—ˆìš©)
            // ì˜ˆ: 100*200*10 ë˜ëŠ” 100 * 200 * 10
            const match = line.match(/(\d+(?:\.\d+)?)\s*[\*xX]\s*(\d+(?:\.\d+)?)\s*[\*xX]\s*(\d+(?:\.\d+)?)/);
            
            if (match) {
                const w = parseFloat(match[1])/10; 
                const l = parseFloat(match[2])/10; 
                const t = parseFloat(match[3])/10;
                
                let g = 7.93; let name = "SUS304";
                if(line.toUpperCase().includes("SS400") || line.includes("ì¼ë°˜ê°•")) { g = 7.85; name = "SS400"; }
                else if(line.toUpperCase().includes("AL") || line.includes("ì•Œë£¨ë¯¸ëŠ„")) { g = 2.7; name = "ì•Œë£¨ë¯¸ëŠ„"; }
                
                // ë¬´ê²Œ ê³„ì‚°
                const wgt = (w * l * t * g) / 1000;
                
                // ëª©ë¡ì— ì¶”ê°€
                itemList.push({ 
                    id: Date.now() + Math.random(), // ê³ ìœ  ID ìƒì„±
                    txt: `${name}(ì‚¬ê°) ${w*10}*${l*10}*${t*10}`, 
                    weight: wgt, 
                    unit: defaultUp 
                });
                count++;
            }
        });

        if (count > 0) {
            alert(`${count}ê°œì˜ í’ˆëª©ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
            renderList();
            document.getElementById('rawText').value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
        } else {
            alert("ê·œê²© í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n(ì˜ˆ: 100*200*10)");
        }
    }

    function generatePdf() {
        document.getElementById('print-date').innerText = "ì¼ì‹œ: " + new Date().toLocaleString();
        window.print();
    }

    function sendToOwner() {
        if(itemList.length === 0) return alert("ëª©ë¡ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.");
        let s = "[ìì¬ ê²¬ì  ìš”ì²­]\n";
        itemList.forEach((item, i) => { s += `${i+1}. ${item.txt}\n`; });
        s += "\nê²¬ì  ë¶€íƒë“œë¦½ë‹ˆë‹¤.";
        location.href = `sms:01000000000?body=${encodeURIComponent(s)}`;
    }
</script>
</body>
</html>
